#!/bin/ksh

set -x

export PS4='$SECONDS + '
date

#########################################
# Run config file to get input parameters
#########################################

if [ "$RUN_ENVIR" != nco ]
then
  . ${PARA_CONFIG:-/global/save/${LOGNAME}/para_gfs/pr4devb/para_config}
  export userid=$LOGNAME
fi

####################################
# Determine Job Output Name on System
####################################

export pid=$$
export pgmout="OUTPUT.${pid}"

####################################
# obtain unique process id (pid) and make temp directory
####################################

export DATA=${DATA:-"${DATAROOT}/${jobid}"}
rm -fr $DATA
mkdir -p $DATA
cd $DATA

export cycle=t${cyc}z

####################################
# Specify NET and RUN Name and model
####################################

export NET=gfs
export RUN=gdas1

####################################
# SENDECF  - Flag Events on ECF
# SENDCOM  - Copy Files From TMPDIR to $COMOUT
# SENDDBN  - Issue DBNet Client Calls
#########################################
export SENDCOM=${SENDCOM:-YES}
export SENDECF=${SENDECF:-YES}

####################################
# Specify Execution Areas
####################################
export HOMEglobal=${HOMEglobal:-$NWROOT/global_shared.${global_shared_ver}}
export FIXglobal=${FIXglobal:-$HOMEglobal/fix}
export FIXglobal_am=${FIXglobal_am:-$HOMEglobal/fix/fix_am}
export EXECglobal=${EXECglobal:-$HOMEglobal/exec}
export USHglobal=${USHglobal:-$HOMEglobal/ush}

##############################
# Run setpdy and initialize PDY variables
##############################
setpdy.sh
. ./PDY

# Set CDATE and GDATE
CDATE=${PDY}${cyc}
GDATE=$($NDATE -06 $CDATE)
PDY_m6hrs=$(echo $GDATE | cut -c1-8)
cyc_m6hrs=$(echo $GDATE | cut -c9-10)
export cycle_m6hrs=t${cyc_m6hrs}z

##############################################
# Define COM directories
##############################################
export COMIN=${COMIN:-${COMROOT}/${NET}/${envir}/gdas.${PDY}}
export COMIN_m6hrs=${COMIN_m6hrs:-${COMROOT}/${NET}/${envir}/gdas.${PDY_m6hrs}}
export COMOUT=${COMOUT:-${COMROOT}/${NET}/${envir}/gdas.${PDY}}

if [ "$SENDCOM" = YES ]; then
  mkdir -p $COMOUT
fi

export IMS_FILE=${COMIN}/${RUN}.${cycle}.imssnow96.grib2
export FIVE_MIN_ICE_FILE=${COMIN}/${RUN}.${cycle}.seaice.5min.grib2
export AFWA_NH_FILE=${COMIN}/${RUN}.${cycle}.NPR.SNWN.SP.S1200.MESH16.grb
export AFWA_SH_FILE=${COMIN}/${RUN}.${cycle}.NPR.SNWS.SP.S1200.MESH16.grb

export FIVE_MIN_ICE_MASK_FILE=${FIXglobal}/emcsfc_gland5min.grib2

export BLENDED_ICE_FILE=${BLENDED_ICE_FILE:-${RUN}.${cycle}.seaice.5min.blend.grb}
export BLENDED_ICE_FILE_m6hrs=${BLENDED_ICE_FILE_m6hrs:-${COMIN_m6hrs}/${RUN}.${cycle_m6hrs}.seaice.5min.blend.grb}


export BLENDICEEXEC=${EXECglobal}/emcsfc_ice_blend
export SNOW2MDLEXEC=${EXECglobal}/emcsfc_snow2mdl

msg="HAS BEGUN on `hostname`"
postmsg "$jlogfile" "$msg"

#############################################################
# Execute the script
$HOMEglobal/scripts/exemcsfc_global_sfc_prep.sh.ecf
export err=$? ; err_chk
#############################################################

if [ -e ${pgmout} ]; then
  cat $pgmout
fi

msg="ENDED NORMALLY."
postmsg "$jlogfile" "$msg"

if [[ ${KEEPDATA} != YES ]]; then
  cd /tmpnwprd2
  rm -fr $DATA
fi

exit 0
